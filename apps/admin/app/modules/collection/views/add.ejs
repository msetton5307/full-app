<% layout(layout_directory+'/mainLayout') -%>

<div class="app-content content ">
  <div class="content-overlay"></div>
  <div class="header-navbar-shadow"></div>
  <div class="content-wrapper container-xxl p-0">
    <div class="content-header row">
      <div class="content-header-left col-md-9 col-12 mb-2">
        <div class="row breadcrumbs-top">
          <div class="col-12">
            <h2 class="content-header-title float-start mb-0">Collections</h2>
            <div class="breadcrumb-wrapper">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="<%= generateUrl('user.dashboard') %>">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="<%= generateUrl('admin.collection.listing')%>">Collections</a></li>
                <li class="breadcrumb-item active"><%= page_title %></li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="content-body">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body py-2">
              <form class="modal-content pt-0" id="add-new-collection" action="<%= generateUrl('collection.insert') %>" method="POST" enctype="multipart/form-data">
                <div class="modal-header mb-1">
                  <h5 class="modal-title" id="exampleModalLabel">Add Collection</h5>
                </div>
                <div class="modal-body flex-grow-1">
                  <div class="row">
                    <div class="col-lg-6 mb-1">
                      <label class="form-label" for="title">Title</label><span style="color: red;">*</span>
                      <input type="text" class="form-control" id="title" placeholder="Collection title" name="title" required />
                    </div>
                    <div class="col-lg-6 mb-1">
                      <label class="form-label" for="description">Description</label>
                      <input type="text" class="form-control" id="description" placeholder="Short description" name="description" />
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-12 mb-1">
                      <label class="form-label" for="deals">Deals</label>
                      <select class="form-select" id="deals" name="deals" multiple>
                        <% deals.forEach(function(deal){ %>
                          <option value="<%= deal._id %>"><%= deal.deal_title %></option>
                        <% }) %>
                      </select>
                      <small class="text-muted">Choose as many deals as you want to include in this collection.</small>
                    </div>
                  </div>
                  <div class="d-flex align-items-center mb-2">
                    <a href="/uploads/noImage.png" target="_blank" class="me-25">
                      <img src="/uploads/noImage.png" id="collection-upload-img" class="rounded me-50" alt="cover image" style="max-width: 100px; max-height: 100px;" />
                    </a>
                    <div class="d-flex align-items-end mt-75 ms-1">
                      <div>
                        <label for="collection-upload" class="btn btn-sm btn-primary mb-75 me-75">Upload Cover</label>
                        <div class="d-flex">
                          <input type="file" name="cover" id="collection-upload" hidden accept="image/*" />
                        </div>
                        <button type="button" id="collection-reset" class="btn btn-sm btn-outline-secondary mb-75 d-none">Reset</button>
                        <p class="mb-0">Upload a cover photo for the collection.</p>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex">
                    <button type="submit" class="btn btn-primary me-1 data-submit">Submit</button>
                    <a class="btn btn-outline-secondary" href="<%= generateUrl('admin.collection.listing')%>">Cancel</a>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const coverUpload = $('#collection-upload');
    const preview = $('#collection-upload-img');
    const resetBtn = $('#collection-reset');
    const dealsSelect = $('#deals');

    dealsSelect.select2({
      placeholder: 'Select deals',
      allowClear: true,
    });

    if (coverUpload.length) {
      const resetImage = preview.attr('src');
      coverUpload.on('change', function (e) {
        const reader = new FileReader();
        const files = e.target.files;
        reader.onload = function () {
          preview.attr('src', reader.result);
        };
        if (files && files[0]) {
          reader.readAsDataURL(files[0]);
          resetBtn.removeClass('d-none');
        }
      });

      resetBtn.on('click', function () {
        preview.attr('src', resetImage);
        coverUpload.val('');
        resetBtn.addClass('d-none');
        return false;
      });
    }
  })();
</script>
