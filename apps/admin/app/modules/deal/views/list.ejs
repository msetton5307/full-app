<% layout(layout_directory+'/mainLayout') -%>
<!-- BEGIN: Content-->
<div class="app-content content ">
  <div class="content-overlay"></div>
  <div class="header-navbar-shadow"></div>
  <div class="content-wrapper container-xxl p-0">
    <div class="content-header row">
    </div>
    <div class="content-body">
      <!-- users list start -->
      <section class="app-user-list">
        <div class="row">
          <div class="col-lg-4 col-sm-6">
              <div class="card">
                  <div class="card-body d-flex align-items-center justify-content-between">
                      <div>
                          <h3 class="fw-bolder mb-75"><%= utils.numFormatter(data.count) %></h3>
                          <span>Total Deals</span>
                      </div>
                      <div class="avatar bg-light-info p-50" style="cursor: default !important;">
                          <span class="avatar-content">
                              <i data-feather="help-circle" class="font-medium-4"></i>
                          </span>
                      </div>
                  </div>
              </div>
          </div>

          <div class="col-lg-4 col-sm-6">
              <div class="card">
                  <div class="card-body d-flex align-items-center justify-content-between">
                      <div>
                          <h3 class="fw-bolder mb-75"><%= utils.numFormatter(data.approvedCount) %></h3>
                          <span>Approved Deals</span>
                      </div>
                      <div class="avatar bg-light-success p-50" style="cursor: default !important;">
                          <span class="avatar-content">
                              <i data-feather="help-circle" class="font-medium-4"></i>
                          </span>
                      </div>
                  </div>
              </div>
          </div>

          <div class="col-lg-4 col-sm-6">
              <div class="card">
                  <div class="card-body d-flex align-items-center justify-content-between">
                      <div>
                          <h3 class="fw-bolder mb-75"><%= utils.numFormatter(data.expiredCount) %></h3>
                          <span>Expired Deals</span>
                      </div>
                      <div class="avatar bg-light-danger p-50" style="cursor: default !important;">
                          <span class="avatar-content">
                              <i data-feather="help-circle" class="font-medium-4"></i>
                          </span>
                      </div>
                  </div>
              </div>
          </div>

          <div class="col-lg-4 col-sm-6">
              <div class="card">
                  <div class="card-body d-flex align-items-center justify-content-between">
                      <div>
                          <h3 class="fw-bolder mb-75"><%= utils.numFormatter(data.pendingCount) %></h3>
                          <span>Pending Deals</span>
                      </div>
                      <div class="avatar bg-light-warning p-50" style="cursor: default !important;">
                          <span class="avatar-content">
                              <i data-feather="clock" class="font-medium-4"></i>
                          </span>
                      </div>
                  </div>
              </div>
          </div>

      </div>

      <div class="card mb-2">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h4 class="card-title mb-0">Deals dashboard</h4>
            <small class="text-muted">Quick insight into clicks, likes and expiration reports</small>
          </div>
          <div class="badge bg-light-primary text-primary">Live overview</div>
        </div>
        <div class="card-body">
          <div class="row g-1 g-md-2">
            <% if (dashboardDeals && dashboardDeals.length) { %>
              <% dashboardDeals.forEach(function(deal) { %>
                <div class="col-xl-4 col-lg-6 col-12">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                      <div class="d-flex align-items-center mb-1">
                        <div class="me-1" style="width: 72px; height: 72px;">
                          <img class="img-fluid rounded" style="object-fit: cover; height: 100%; width: 100%;" src="<%= deal.primaryImage ? (deal.primaryImage.startsWith('http') ? deal.primaryImage : '/uploads/DealImages/' + deal.primaryImage) : '/uploads/noImage.png' %>" alt="Deal image">
                        </div>
                        <div class="flex-fill">
                          <h5 class="mb-25 text-truncate" title="<%= deal.deal_title %>"><%= deal.deal_title %></h5>
                          <div class="d-flex align-items-center flex-wrap gap-50">
                            <span class="badge rounded-pill <%= deal.status === 'Expired' ? 'bg-danger' : 'bg-success' %>"><%= deal.status %></span>
                            <% if (deal.discount) { %>
                              <span class="badge rounded-pill bg-light-primary text-primary"><%= deal.discount %>% off</span>
                            <% } %>
                          </div>
                        </div>
                      </div>

                      <div class="mb-1 d-flex align-items-center gap-50 flex-wrap">
                        <div class="d-flex align-items-center">
                          <i data-feather="eye" class="me-50"></i><span class="fw-bold"><%= utils.numFormatter(deal.clickCount || 0) %></span>
                          <small class="text-muted ms-50">views</small>
                        </div>
                        <div class="d-flex align-items-center">
                          <i data-feather="external-link" class="me-50"></i><span class="fw-bold"><%= utils.numFormatter(deal.ctaClickCount || 0) %></span>
                          <small class="text-muted ms-50">see deal clicks</small>
                        </div>
                        <div class="d-flex align-items-center">
                          <i data-feather="alert-circle" class="me-50 text-danger"></i><span class="fw-bold"><%= utils.numFormatter(deal.expiredReports || 0) %></span>
                          <small class="text-muted ms-50">expired reports</small>
                        </div>
                      </div>

                      <div class="mb-1 d-flex align-items-center gap-1 flex-wrap">
                        <span class="badge rounded-pill bg-light-success text-success d-inline-flex align-items-center"><i data-feather="thumbs-up" class="me-50"></i><%= utils.numFormatter(deal.likes || 0) %></span>
                        <span class="badge rounded-pill bg-light-danger text-danger d-inline-flex align-items-center"><i data-feather="thumbs-down" class="me-50"></i><%= utils.numFormatter(deal.dislikes || 0) %></span>
                        <% if (deal.status !== 'Expired' && deal.expiredReports > 0) { %>
                          <form class="ms-auto" method="POST" action="<%= generateUrl('deal.markExpired', { id: deal._id }) %>" onsubmit="return confirm('Mark this deal as expired?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Mark expired</button>
                          </form>
                        <% } else if (deal.status === 'Expired') { %>
                          <span class="ms-auto badge rounded-pill bg-danger">Expired</span>
                        <% } %>
                      </div>

                      <% if (deal.product_link) { %>
                        <div class="mt-auto">
                          <a class="btn btn-outline-primary w-100" href="<%= deal.product_link %>" target="_blank" rel="noopener noreferrer">See deal</a>
                        </div>
                      <% } %>
                    </div>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <div class="col-12">
                <div class="alert alert-warning mb-0">No deals found to populate the dashboard.</div>
              </div>
            <% } %>
          </div>
        </div>
      </div>

        </div>
        <!-- list and filter start -->
        <div class="card">
          <div class="card-body border-bottom">
            <h4 class="card-title"><%= page_title %></h4>
            <div class="row">
              <div class="col-md-4 user_status">
                  <select id="DealStatusDropdown" class="form-select text-capitalize mb-md-0 mb-2xx cursor-pointer">
                      <option value=""> View All Status </option>
                      <option value="Approved" <%= status && status=='Approved'?'selected':'' %>> Approved </option>
                      <option value="Pending" <%= status && status=='Pending'?'selected':'' %>> Pending </option>
                      <option value="Rejected" <%= status && status=='Rejected'?'selected':'' %>> Rejected </option>
                      <option value="Expired" <%= status && status=='Expired'?'selected':'' %>> Expired </option>
                  </select>
              </div>
          </div>
          </div>
          <div class="card-datatable table-responsive pt-0">
            <section id="loader"></section>
            <table class="deal-list-table table">
              <thead class="table-light">
                <tr>
                  <th></th>
                  <!-- <th>Deal Image</th> -->
                  <th>Deal Title</th>
                  <th style="text-align: center;">Deal Price</th>
                  <th style="text-align: center;">Product Link</th>
                  <th>Status</th>
                  <!-- <th>Actions</th> -->
                </tr>
              </thead>
            </table>
          </div>

        </div>
        <div class="modal fade" id="dealDetailsModal" tabindex="-1" aria-labelledby="dealDetailsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="dealDetailsModalLabel">Deal Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-4 text-center mb-2 mb-md-0">
                    <img id="deal-details-image" src="/uploads/noImage.png" alt="Deal image" class="img-fluid rounded">
                  </div>
                  <div class="col-md-8">
                    <dl class="row mb-0">
                      <dt class="col-sm-4">Title</dt>
                      <dd class="col-sm-8" id="deal-details-title">N/A</dd>

                      <dt class="col-sm-4">Company</dt>
                      <dd class="col-sm-8" id="deal-details-company">N/A</dd>

                      <dt class="col-sm-4">Type</dt>
                      <dd class="col-sm-8" id="deal-details-type">N/A</dd>

                      <dt class="col-sm-4">Subtype</dt>
                      <dd class="col-sm-8" id="deal-details-subtype">N/A</dd>

                      <dt class="col-sm-4">Price</dt>
                      <dd class="col-sm-8" id="deal-details-price">N/A</dd>

                      <dt class="col-sm-4">Original Price</dt>
                      <dd class="col-sm-8" id="deal-details-original">N/A</dd>

                      <dt class="col-sm-4">Discount</dt>
                      <dd class="col-sm-8" id="deal-details-discount">N/A</dd>

                      <dt class="col-sm-4">Link</dt>
                      <dd class="col-sm-8"><a id="deal-details-link" href="#" target="_blank" rel="noopener noreferrer">N/A</a></dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- list and filter end -->
      </section>
      <!-- users list ends -->

    </div>
  </div>
</div>
<!-- END: Content-->

<!-- BEGIN: Datatable JS-->
<script src="/js/datatables/app-deal-list.js"></script>
<!-- END: Datatable JS-->

